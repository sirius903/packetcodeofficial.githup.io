<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>
  <script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js';
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, setDoc, doc, onSnapshot, initializeFirestore, memoryLocalCache } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js';
import { getDatabase, ref, set, onValue, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js';

const firebaseConfig = {
    apiKey: "AIzaSyCH19uFh4bPcFHJJxLNEnd6syxell55Sqw",
    authDomain: "new-project-6f342.firebaseapp.com",
    databaseURL: "https://new-project-6f342-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "new-project-6f342",
    storageBucket: "new-project-6f342.appspot.com",
    messagingSenderId: "117809923508",
    appId: "1:117809923508:web:f5b688225998923ecc9ee1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const database = getDatabase(app);

    // const abc = await getDocs(collection(db, "Auths"))
    // abc.forEach((doc) => {
    //   console.log(doc.data().id)
    // })

function entry(x, y){
  document.getElementById('main-menu_btns').className = ['', 'hidden'][x + 0];
  document.getElementById('exit_section').className = ['hidden', ''][x + 0];
  document.getElementById('entry_section').className = ['hidden', ''][x + 0];
  document.querySelector('.background').style.background = ['background: linear-gradient(to bottom,#1c4a70, #040c12)', 'linear-gradient(to bottom,#040c12, #1c4a70)'][x + 0];
  if(x){
    document.getElementById('log-in_section').className = ['', 'hidden'][y];
    document.getElementById('sign-up_section').className = ['hidden', ''][y];
  }
}

function connect(){
  const user = getAuth().currentUser;
  document.getElementById('my-id').replaceChildren(user.displayName);
  onValue(ref(database, 'user'), (snapshot) => {
    const data = snapshot.val();
    const players = Object.keys(data).map(i => data[i]).filter(x => x.status != 'offline');
    document.getElementById('players-list').replaceChildren('');
    players.forEach(a => {
      let player = document.createElement('div');
      player.className = 'player';
      player.innerHTML = `<div class="player-level">Lv. ${a.level}</div>
              <div class="player-id">${a.displayName}</div>
              <div class="player-status ${a.status}">●</div>`;
      document.getElementById('players-list').append(player);
    })
    document.getElementById('my-level').replaceChildren(`Lv. ${players.filter(x => x.displayName == user.displayName)[0].level}`);
    document.getElementById('players-number').innerText = `(${players.length} / 100)`;
  })
  document.addEventListener("visibilitychange", () => {
    if(document.hidden){
      set(ref(database, 'user/' + user.uid + '/status'), 'away');
    }else{
      set(ref(database, 'user/' + user.uid + '/status'), 'online');
    }
  });
  document.querySelector('.main-menu').className = 'main-menu container hidden';
  document.querySelector('.list').className = 'list container';
  entry(false);
}

document.getElementById('to_log-in').addEventListener("click", function(){
  entry(true, 0);
});

document.getElementById('to_sign-up').addEventListener("click", function(){
  entry(true, 1);
});

document.getElementById('exit_section').addEventListener("click", function(){
  entry(false);
});

document.getElementById('log-in').addEventListener("click", function(){
  let email = document.getElementById('log-in_email').value;
  let password = document.getElementById('log-in_password').value;
  signInWithEmailAndPassword(auth, email, password).then((user) => {
    set(ref(database, 'user/' + user.user.uid + '/status'), 'online');
    onDisconnect(ref(database, 'user/' + user.user.uid + '/status')).set('offline');
    connect();
  }).catch((error) => {
    console.log(error.code);
    console.log(error.message);
  });
});

document.getElementById('change_to_regist').addEventListener("click", function(){
  entry(true, 1);
});

//play as guest

document.getElementById('sign-up_id').addEventListener("focusout", async function(){
  let message = 'Is available!';
  let id = document.getElementById('sign-up_id').value;
  let id_list = [];
  const ids = await getDocs(collection(db, "Auths"));
  ids.forEach((doc)=>{
    id_list.push(doc.data().id);
  });
  if(id === ''){
    message = 'Is blank!';
  }else if(id_list.includes(id)){
    message = 'Duplicates!';
  }else{
  }
  if(message == 'Is available!'){
    document.getElementById('id-error').className = '';
  }else{
    document.getElementById('id-error').className = 'error';
  }
  document.getElementById('id-error').replaceChildren(message);
})

document.getElementById('sign-up').addEventListener("click", function(){
  let email = document.getElementById('sign-up_email').value;
  let password = document.getElementById('sign-up_password').value;
  let id = document.getElementById('sign-up_id').value;
  createUserWithEmailAndPassword(auth, email, password).then((user) => {
    updateProfile(auth.currentUser, {
      displayName : id
    }).then(() => {
      setDoc(doc(db, "Auths", user.user.uid), {
        id : id
      })
      set(ref(database, 'user/' + user.user.uid), {
        displayName : id,
        email : email,
        level : 1,
        status : 'online'
      });
      onDisconnect(ref(database, 'user/' + user.user.uid + '/status')).set('offline');
      connect();
    }).catch((error) =>{
      console.log(error.code);
      console.log(error.message);
    })
  }).catch((error) => {
    console.log(error.code);
    console.log(error.message);
  })
});

document.getElementById('change_to_login').addEventListener("click", function(){
  entry(true, 0);
});





    var rooms = [];
    const roomLoad = onSnapshot(collection(db, "Rooms"), (doc) => {
      rooms = [];
      doc.forEach(a => rooms.push(a.data()));

      var add_item = document.createElement('div');
      add_item.className = 'rooms_item add_btn';
      add_item.innerHTML = '<div id="text">New Room</div>';
      add_item.addEventListener("click", ()=>{
        // document.querySelector('.list_box').className = 'list_box container hidden';
        // document.querySelector('.generate').className = 'generate container';
        console.log('clicked!');
      })
      document.getElementById('rooms').append(add_item);
      rooms.forEach(a => {
        let item = document.createElement('div');
        item.className = 'rooms_item';
        item.innerHTML = `<div class="rooms-title">${a.name}</div><div class="rooms-limit">${'1 / ' + a.limit}</div>`;
        document.getElementById('rooms').append(item);
      })
      for(let i = 3 - rooms.length % 3; i > 1; i--){
        let item = document.createElement('div');
        item.className = 'rooms_item';
        document.getElementById('rooms').append(item);
      }
    });

    const chatsLoad = onSnapshot(doc(db, "Chats", "Full-Chats"), (snapshot) => {
      if(snapshot.data().message != ''){
        let full_chat = document.getElementById('full-chat');
        let scroll = true;
        if(full_chat.scrollTop + full_chat.clientHeight + 5 < full_chat.scrollHeight) scroll = false;
        full_chat.innerHTML += `
          <div class="chat-message">
            <h1 class="chat-tag">${snapshot.data().tag}</h1>
            <p>${snapshot.data().message}</p>
          </div>`;
        if(scroll) full_chat.scrollTop = full_chat.scrollHeight;
        setDoc(doc(db, "Chats", "Full-Chats"), {
          message : ''
        })
      }
    })
    window.onload = function(){
      document.getElementById('full-chat-input').addEventListener("keydown", function(e){
        if(e.code === 'Enter'){
          if (event.isComposing) return;
          setDoc(doc(db, "Chats", "Full-Chats"), {
            tag : auth.currentUser.displayName,
            message : document.getElementById('full-chat-input').value
          })
          document.getElementById('full-chat-input').value = '';
        }
      })
    }
  </script>

  <div>
    <div class="main-menu container">
      <div class="background">
        <div id="title">
          <div class="title" id="title1">Crash</div>
          <div class="title" id="title2">Card</div>
        </div>
        <div id="main-menu_btns">
          <div id="to_log-in" class="main-menu_btn">Log In</div>
          <div id="to_sign-up" class="main-menu_btn">Sign Up</div>
        </div>
        <div id="exit_section" class="hidden">Exit</div>
        <div id="entry_section" class="hidden">
          <div id="log-in_section">
            <h1>Welcom!</h1>
            <div class="entry_row">
              <div class="entry_label">Email</div>
              <input class="entry_item" id="log-in_email" type="email">
            </div>
            <div class="entry_row">
              <div class="entry_label">Password</div>
              <input class="entry_item" id="log-in_password" type="password">
            </div>
            <div id="log-in" class="entry">LOG IN</div>
            <a class="text">Unless yet registered</a>
            <a id="change_to_regist">Go to regist</a>
            <a class="text">or</a>
            <a id="guest">Play as a guest</a>
          </div>
          <div id="sign-up_section" class="hidden">
            <h1>New Account</h1>
            <div class="entry_row">
              <div class="entry_label">Email</div>
              <input class="entry_item" id="sign-up_email">
            </div>
            <div class="entry_row">
              <div class="entry_label">Password</div>
              <input class="entry_item" id="sign-up_password">
            </div>
            <div class="entry_row">
              <div class="entry_label">GameId</div>
              <input class="entry_item" id="sign-up_id">
            </div>
            <div id="id-error"></div>
            <div id="sign-up" class="entry">SIGN UP</div>
            <a class="text">If already registered</a>
            <a id="change_to_login">Go to login</a>
          </div>
        </div>
      </div>
    </div>
    <div class="entry container hidden"></div>
    <div class="list container hidden">
      <div id="players">
        <div id="my-profile">
          <img id="my-avatar" src="https://fastly.picsum.photos/id/251/250/250.jpg?hmac=_NUJeiKDfHVqhYGCW_85ojnjvg9ZWfHfMGppohybKyE">
          <div id="my-data">
            <div id="my-id"></div>
            <div id="my-level"></div>
          </div>
        </div>
        <div id="other-players">
          <div id="players-title">
            <h1 class="title">Players</h1>
            <div id="players-number">(0 / 100)</div>
          </div>
          <div id="players-list">
            <!-- <div class="player">
              <div class="player-level">Lv. 1</div>
              <div class="player-id">dummy</div>
              <div class="player-status online">●</div>
            </div> -->
          </div>
        </div>
      </div>
      <div id="rooms-list">
        <h1 class="title">ROOMS</h1>
        <input id="rooms-id" placeholder="enter room id and hit enter..." autocomplete="off" type="text">
        <div id="rooms" class="scroller">
          <!--
            <div class="rooms_item">
              <div class="rooms-title">방 이름</div>
              <div class="rooms-limit">1 / 4</div>
            </div>
          -->
        </div>
      </div>
      <div class="chat-box" id="full-chat-box">
        <h1 class="title">CHAT</h1>
        <div id="full-chat" class="chat scroller">
          <div class="chat-message chat-banner">
            <h1 class="chat-tag">[CMD]</h1>
            <p>Welcome to chat! Please remember to be civil to your opponents.</p>
          </div>
          <!-- 
            <div class="chat-message">
              <h1 class="chat-tag">anonymous</h1>
              <p>message</p>
            </div> 
          -->
        </div>
        <input id="full-chat-input" class="chat-input" placeholder="message..." autocomplete="off" type="text">
      </div>
    </div>
    <div class="room container hidden">
      <div class="players-list"></div>
      <div id="room-content">
        <!-- <h1 id="room_content_name">-</h1>
        <p id="moreinfo">hover over a setting for more info</p>
        <div style="display: flex;">
            <div class="room_tabs flex-column">
                <div class="room_tab active" onclick="tab(0)">Room</div>
                <div class="room_tab" onclick="tab(1)">Match</div>
                <div class="room_tab" onclick="tab(2)">Game</div>
            </div>
            <div class="scroller room_content">
                <div>
                    <div class="config_row">
                        <div class="config_label flex-item">room name</div>
                        <input id="name" class="config_item flex-item" value="-">
                    </div>
                    <div class="config_row">
                        <div class="config_label flex-item">player limit</div>
                        <input type="number" id="limit" class="config_item flex-item" max="4" min="2" value="2">
                    </div>
                </div>
            </div>
            <div class="scroller room_content hidden">2</div>
            <div class="scroller room_content hidden">3</div>
        </div>
        <div id="create_button">CREATE</div> -->
      </div>
      <div class="chat-box"></div>
    </div>
    <div class="game container hidden"></div>
  </div>
</body>
</html>